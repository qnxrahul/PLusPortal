@page "{vacancyId}"
@model Steer73.RockIT.Web.Pages.VacancyDetailModel
@using Steer73.RockIT.Enums

@{
    Layout = "_CandidatePortalLayout.cshtml";
}

@section styles {
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.core.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet" />
    <style>
        #vacancy-viewer .ql-editor {
            line-height: 1.4;
        }

        #vacancy-viewer .ql-editor p {
            margin: 0 0 0.75rem;
        }

        #vacancy-viewer .ql-editor ul,
        #vacancy-viewer .ql-editor ol {
            margin: 0 0 0.75rem;
            padding-left: 1.5rem;
        }

        #vacancy-viewer .ql-editor li {
            line-height: 1.4;
            margin: 0.25rem 0;
        }

        #vacancy-viewer .ql-editor h1,
        #vacancy-viewer .ql-editor h2,
        #vacancy-viewer .ql-editor h3 {
            margin: 0 0 0.75rem;
            line-height: 1.2;
            font-weight: 600;
        }
    </style>
}

<div class="container main">
    <div class="row">
        <div class="col-sm-12 col-md-8 col-lg-9">
            <div class="vacancy__details d-flex gap-5">
                @{
                    var logoUrl = string.IsNullOrWhiteSpace(Model.VacancyDto.Company.LogoUrl)
                    ? "/images/company/default-company-logo.jpg"
                    : Model.VacancyDto.Company.LogoUrl;
                }
                <img class="flex-grow-0 flex-shrink-0" src="@logoUrl" />
                <div class="d-flex flex-grow-1 flex-column gap-lg-2">
                    <div class="d-flex gap-5 justify-content-between">
                        <span class="title">@Model.VacancyDto.Vacancy.Title</span>
                        <span class="reference vacancy__pill">@Model.VacancyDto.Vacancy.ProjectId</span>
                    </div>
                    <div class="d-flex flex-column">
                        <span>@Model.VacancyDto.Company?.Name</span>
                        <span class="text-black-50">@Model.VacancyDto.Vacancy.Location</span>
                    </div>
                    @if (Model.VacancyDto.Vacancy.VacancyStatus != VacancyStatus.Expired.ToString() 
                        && Model.VacancyDto.Vacancy.VacancyStatus != VacancyStatus.Closed.ToString())
                    {
                        <a class="btn btn-primary" href="/VacancyForm/@Model.VacancyId">Apply Now</a>
                    }
                </div>
            </div>
        </div>
        <div class="col-sm-12 col-md-4 col-lg-3 mt-2 mt-lg-0">
            <div class="card vacancy__creator">
                <div class="d-flex flex-column gap-3">
                    <p class="text-black-50">Role coordinated by:</p>
                    <div class="d-flex flex-row">
                        <img src="/api/account/profile-picture-file/@Model.VacancyDto.IdentityUser.Id" />
                        <div class="d-flex flex-column justify-content-center ms-2">
                            <span class="fw-bold vacancy__creator-name">@Model.VacancyDto.IdentityUser.Name @Model.VacancyDto.IdentityUser.Surname</span>
                            <span>@Model.CompanyRole</span>
                        </div>
                    </div>
                    <div class="d-flex flex-column">
                        @if (!string.IsNullOrEmpty(Model.VacancyDto.IdentityUser.PhoneNumber))
                        {
                            <span>t: @Model.VacancyDto.IdentityUser.PhoneNumber</span>
                        }
                        @if (!string.IsNullOrEmpty(Model.VacancyDto.IdentityUser.Email))
                        {
                            <span>e: <a href="mailto:@Model.VacancyDto.IdentityUser.Email">@Model.VacancyDto.IdentityUser.Email</a></span>
                        }
                    </div>
                </div>
            </div>
        </div>
        <div class="divider my-4 my-lg-5"></div>
        <div class="vacancy__info col-12">
            <div>
                <span>Sector</span>    
                <span>@string.Join(", ", Model.VacancyDto.Vacancy.GroupNames)</span>
            </div>
            <div>
                <span>Salary & Benefits</span>
                <span>@Model.VacancyDto.Vacancy.Salary @Model.VacancyDto.Vacancy.Benefits</span>
            </div>
            <div>
                <span>Expiry 


                </span>
                <span>@Model.VacancyDto.Vacancy.ExpiringDate.ToString("dd/MM/yyyy")</span>
            </div>
           @*  <div>
                <span>Formal Interview Date</span>
                <span>@Model.VacancyDto.Vacancy.FormalInterviewDate</span>
            </div> *@
        </div>
        <div class="divider my-4 my-lg-5"></div>
        
        @{
            var todayDateOnly = DateOnly.FromDateTime(DateTime.UtcNow);
            bool isTrulyExpired =
            Model.VacancyDto.Vacancy.VacancyStatus == VacancyStatus.Expired.ToString()
            && todayDateOnly > Model.VacancyDto.Vacancy.ExpiringDate;
        }

        @if (Model.VacancyDto.Vacancy.VacancyStatus == VacancyStatus.Expired.ToString() 
        || isTrulyExpired)
        {
            <div class="col-12">
                <div class="alert alert-danger" role="alert">
                    This vacancy is no longer available.
                </div>
            </div>
        } else {
            <div class="col-12">
                <div id="vacancy-viewer"></div>
            </div>
            <div class="vacancy__action col-12 ">
                <a class="btn btn-secondary" href="/VacancyMoreInfo/@Model.VacancyId">Request More Information</a>
                <a class="btn btn-primary" href="/VacancyForm/@Model.VacancyId">Apply Now</a>
            </div>
        }
    </div>
</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var container = document.getElementById('vacancy-viewer');
            if (!container) return;

            var quill = new Quill('#vacancy-viewer', {
                readOnly: true,
                theme: 'snow',
                modules: { toolbar: false }
            });

            // Prefer Delta if present; fallback to HTML
            var content = @Html.Raw(Json.Serialize(Model.VacancyDto.Vacancy.Description));
            try {
                var delta = content && content.trim().startsWith('{') ? JSON.parse(content) : null;
                if (delta && delta.ops) {
                    quill.setContents(delta);
                } else {
                    quill.clipboard.dangerouslyPasteHTML(content || '');
                }
            } catch (e) {
                quill.clipboard.dangerouslyPasteHTML(content || '');
            }
        });
    </script>
}