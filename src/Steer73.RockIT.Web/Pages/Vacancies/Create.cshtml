@page
@using Microsoft.AspNetCore.Mvc.Localization
@using Steer73.RockIT.Enums
@using Steer73.RockIT.Localization
@using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Modal
@using Steer73.RockIT.Web.Pages.Vacancies
@using Steer73.RockIT.Vacancies;
@using System.Globalization
@inject IHtmlLocalizer<RockITResource> L
@model CreateModel


@section styles {
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.core.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet" />
    <style>
        .abp-view-modal .modal {
            position: static;
            display: block;
            opacity: inherit !important;
        }

            .abp-view-modal .modal.fade .modal-dialog {
                transition: inherit !important;
                transform: inherit !important;
                max-width: 100%;
            }

        .abp-view-modal .modal-header .btn-close {
            display: none;
        }

        #Vacancy_Description-error {
            display: block;
        }

        #editor {
            height: 12rem;
            max-height: 12rem;
            overflow: auto;
        }

        .ql-editor {
            line-height: 1.4;
        }
        .ql-editor p {
            margin: 0 0 0.75rem;
        }
        .ql-editor ul,
        .ql-editor ol {
            margin: 0 0 0.75rem;
            padding-left: 1.5rem;
        }
        .ql-editor li {
            line-height: 1.4;
            margin: 0.25rem 0;
        }
        .ql-editor h1,
        .ql-editor h2,
        .ql-editor h3 {
            margin: 0 0 0.75rem;
            line-height: 1.2;
            font-weight: 600;
        }
    </style>
}
@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    <abp-script src="/Pages/Vacancies/create.js" />
    <script>
        let quill = null;

        window.addEventListener("DOMContentLoaded", (event) => {
            // Allow mailto: and tel: links in Quill's link sanitizer
            try {
                const Link = Quill.import('formats/link');
                const originalSanitize = Link.sanitize;
                Link.sanitize = function (url) {
                    const val = originalSanitize.call(this, url);
                    if (!val) return val;
                    if (val.startsWith('mailto:') || val.startsWith('tel:')) {
                        return val;
                    }
                    return val;
                };
                Quill.register(Link, true);
            } catch { /* ignore if not available */ }

            quill = new Quill('#editor', {
                theme: 'snow',
                placeholder: 'Write the vacancy description here. Use headings, bullet lists, and formatting as needed...',
                modules: {
                    toolbar: [
                        [{ header: [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline'],
                        [{ list: 'ordered' }, { list: 'bullet' }],
                        [{ indent: '-1' }, { indent: '+1' }],
                        ['link', 'clean']
                    ]
                },
                formats: [
                    'header',
                    'bold', 'italic', 'underline',
                    'list', 'indent',
                    'link'
                ]
            });

            const content = @Html.Raw(Json.Serialize(Model.Vacancy.Description));
            try {
                const delta = content && content.trim().startsWith('{') ? JSON.parse(content) : null;
                if (delta && delta.ops) {
                    quill.setContents(delta);
                } else {
                    quill.clipboard.dangerouslyPasteHTML(content || '');
                }
            } catch { quill.clipboard.dangerouslyPasteHTML(content || ''); }

            let $form = $('#createForm');

            $form.on('submit', function (e) {
                const quillContent = document.querySelector('input#Vacancy_Description');
                // Save as HTML so backend sanitization and rendering work as expected
                quillContent.value = !isQuillEmpty(quill) ? quill.root.innerHTML : '';
            });

            // Add keyboard shortcuts for indent/outdent (Tab / Shift+Tab)
            try {
                quill.keyboard.addBinding({ key: 9, shiftKey: false }, function () {
                    quill.format('indent', '+1');
                    return false; // prevent focus change
                });
                quill.keyboard.addBinding({ key: 9, shiftKey: true }, function () {
                    quill.format('indent', '-1');
                    return false;
                });
            } catch { /* ignore if not available */ }

        });

        function isQuillEmpty(quillInstance) {
            if ((quillInstance.getContents()['ops'] || []).length !== 1) { return false }
            return quillInstance.getText().trim().length === 0
        }
    </script>
}

<div class="abp-view-modal">
    <form id="createForm" asp-page="/Vacancies/Create" autocomplete="off">
        <abp-modal id="VacancyCreateModal">
            <abp-modal-header title="@L["NewVacancy"].Value"></abp-modal-header>

            <abp-modal-body>
                <div class="input-group mb-3">
                    <input type="text"  
                        class="form-control"
                        placeholder=" @L["EnterEzekiaId"].Value"
                        id="projectId"/>
                    <button class="btn btn-outline-secondary" type="button" id="searchProjectId">
                        @L["Confirm"].Value
                    </button>
                </div>
               
                <abp-input asp-for="Vacancy.Title" />

                <div class="mb-3">
                    <label class="form-label" asp-for="Vacancy.CompanyId"></label><span> *</span>
                    <select asp-for="Vacancy.CompanyId"
                            class="auto-complete-select"
                            data-autocomplete-api-url="/api/app/companies/for-auto-complete"
                            data-autocomplete-display-property="name"
                            data-autocomplete-value-property="id"
                            data-autocomplete-items-property="items"
                            data-autocomplete-filter-param-name="filter">
                    </select>
                    <span asp-validation-for="Vacancy.CompanyId" class="text-danger"></span>
                </div>

                <abp-input asp-for="Vacancy.ExternalRefId" readonly="true"/>

                <abp-select asp-for="Vacancy.IdentityUserId" asp-items="Model.IdentityUserLookupListRequired" />

                <div class="mb-3">
                    <label class="form-label" asp-for="Vacancy.ContributorIds"></label>
                    <select asp-for="Vacancy.ContributorIds"
                            class="auto-complete-select"
                            multiple="multiple"
                            data-autocomplete-api-url="/api/app/vacancies/for-user-auto-complete"
                            data-autocomplete-display-property="name"
                            data-autocomplete-value-property="id"
                            data-autocomplete-items-property="items"
                            data-autocomplete-filter-param-name="filter">
                    </select>
                    <span asp-validation-for="Vacancy.ContributorIds" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label class="form-label" asp-for="Vacancy.PracticeGroupIds"></label><span> *</span>
                    <select asp-for="Vacancy.PracticeGroupIds"
                            class="auto-complete-select"
                            multiple="multiple"
                            data-autocomplete-api-url="/api/app/practice-groups/for-auto-complete"
                            data-autocomplete-display-property="name"
                            data-autocomplete-value-property="id"
                            data-autocomplete-items-property="items"
                            data-autocomplete-filter-param-name="filter">
                        @foreach (var practiceGroup in Model.SelectedPracticeGroups)
                        {
                            <option selected value="@practiceGroup.Id">@practiceGroup.Name</option>
                        }
                    </select>
                    <span asp-validation-for="Vacancy.PracticeGroupIds" class="text-danger"></span>
                </div>

                <abp-input asp-for="Vacancy.Role" />

                <div class="mb-3">
                    <label class="form-label" asp-for="Vacancy.RoleTypeIds"></label>
                    <select asp-for="Vacancy.RoleTypeIds"
                            class="auto-complete-select"
                            multiple="multiple"
                            data-autocomplete-api-url="/api/app/vacancies/of-role-types"
                            data-autocomplete-display-property="name"
                            data-autocomplete-value-property="id"
                            data-autocomplete-items-property="items"
                            data-autocomplete-filter-param-name="filter">
                        @foreach (var roleType in Model.SelectedRoleTypes)
                        {
                            <option selected value="@roleType.Id">@roleType.Name</option>
                        }
                    </select>

                    <span asp-validation-for="Vacancy.RoleTypeIds" class="text-danger"></span>
                </div>

                <abp-input asp-for="Vacancy.Salary" />

                <abp-input asp-for="Vacancy.Benefits" />

                <abp-input asp-for="Vacancy.Location" />

                <div class="mb-3">
                    <label class="form-label" asp-for="Vacancy.Regions"></label><span> *</span>
                    <select asp-for="Vacancy.Regions"
                            class="auto-complete-select"
                            multiple="multiple"
                            data-autocomplete-api-url="/api/app/regions"
                            data-autocomplete-display-property="description"
                            data-autocomplete-value-property="id"
                            data-autocomplete-items-property="items"
                            data-autocomplete-filter-param-name="filter">
                        @if (Model.Vacancy.Regions != null)
                        {
                            foreach (var region in Model.Vacancy.Regions)
                            {
                                <option selected value="@((int)region)">@region.GetDescription()</option>
                            }
                        }
                    </select>
                    <span asp-validation-for="Vacancy.Regions" class="text-danger"></span>
                </div>

                <abp-input asp-for="Vacancy.Description" hidden="true" add-margin-bottom-class="false" />
                <div id="editor" class="mb-3"></div>
                <div class="form-text mb-3">
                    Tips:
                    <ul class="mb-0">
                        <li>Use the Headings dropdown to set <strong>Paragraph</strong>, <strong>Heading 1</strong> (Title), <strong>Heading 2</strong> (Header), or <strong>Heading 3</strong>.</li>
                        <li>Increase/decrease indentation using the indent buttons on the toolbar or with <strong>Tab</strong> / <strong>Shift+Tab</strong>.</li>
                        <li>Select text, click the link icon, and paste the address. For email links, use <code>mailto:someone@example.com</code>.</li>
                    </ul>
                </div>
                <input type="hidden" name="Content" id="quillContent">

                <abp-input asp-for="Vacancy.BrochureFileId" type="hidden" />
                <div class="mb-3">
                    <label for="vacancybrochureFileFile" class="form-label">@L["BrochureFile"]</label>
                    <input class="form-control" type="file" id="vacancybrochureFileFile" name="vacancybrochureFileFile" />
                    <span class="text-danger field-validation-valid" data-valmsg-for="vacancybrochureFileFile" data-valmsg-replace="true"></span>
                    <abp-button size="Small" button-type="Primary" class="js-clear-file mt-1" data-input-id="vacancybrochureFileFile" data-file-id="Vacancy_BrochureFileId">@L["ClearFile"]</abp-button>
                </div>

                <abp-input asp-for="Vacancy.AdditionalFileId" type="hidden" />
                <div class="mb-3">
                    <label for="vacancyadditionalFileFile" class="form-label">@L["AdditionalFile"]</label>
                    <input class="form-control" type="file" id="vacancyadditionalFileFile" name="vacancyadditionalFileFile" />
                    <span class="text-danger field-validation-valid" data-valmsg-for="vacancyadditionalFileFile" data-valmsg-replace="true"></span>
                    <abp-button size="Small" button-type="Primary" class="js-clear-file mt-1" data-input-id="vacancyadditionalFileFile" data-file-id="Vacancy_AdditionalFileId">@L["ClearFile"]</abp-button>
                </div>

                <abp-input asp-for="Vacancy.FormalInterviewDate" />

                <abp-input asp-for="Vacancy.SecondInterviewDate" />

                <abp-date-picker asp-for="Vacancy.ExternalPostingDate" min-date="@DateTime.Now" visible-date-format="DD/MM/YYYY" required />

                <abp-date-picker asp-for="Vacancy.ExpiringDate" min-date="@DateTime.Now" visible-date-format="DD/MM/YYYY" required />

                <abp-date-picker asp-for="Vacancy.ClosingDate" min-date="@DateTime.Now" visible-date-format="DD/MM/YYYY" required />

                <div class="mb-3">
                    <label class="form-label" asp-for="Vacancy.MediaSourceIds"></label>
                    <select asp-for="Vacancy.MediaSourceIds"
                            class="auto-complete-select"
                            multiple="multiple"
                            data-autocomplete-api-url="/api/app/vacancies/of-media-sources"
                            data-autocomplete-display-property="name"
                            data-autocomplete-value-property="id"
                            data-autocomplete-items-property="items"
                            data-autocomplete-filter-param-name="filter">
                        @foreach (var mediaSource in Model.SelectedMediaSources)
                        {
                            <option selected value="@mediaSource.Id">@mediaSource.Name</option>
                        }
                    </select>
                </div>

                <abp-select asp-for="Vacancy.VacancyFormDefinitionId" asp-items="Model.VacancyFormDefinitionLookupList" label="@L["VacancyFormDefinition"].Value" />

                <abp-select asp-for="Vacancy.DiversityFormDefinitionId" asp-items="Model.DiversityFormDefinitionLookupList" label="@L["DiversityFormDefinition"].Value" />

                <abp-input asp-for="Vacancy.LinkedInUrl" />

                <abp-input asp-for="Vacancy.Reference" readonly="@(true)" />

                <abp-input asp-for="Vacancy.ShowDiversity" />

                <abp-input asp-for="Vacancy.Flag_HideVacancy" label="@L["FlagHideVacancy"].Value" />
            </abp-modal-body>

            <abp-modal-footer>
                <a class="btn btn-outline-primary" href="/Vacancies" type="button">Cancel</a>
                <button class="btn btn-primary" data-busy-text="Saving..." type="submit"><i class="fa fa-check"></i> <span>Save</span></button>
            </abp-modal-footer>
        </abp-modal>
    </form>
</div>
