@page
@{
    Layout = "/Pages/_AdminLayout.cshtml";
}
@using Microsoft.AspNetCore.Mvc.Localization
@using Steer73.RockIT.Localization
@inject IHtmlLocalizer<RockITResource> L

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="m-0">@L["Vacancies"]</h2>
        <a class="btn btn-primary btn-sm" href="/Vacancies/Create">
            <i class="fa fa-plus"></i> @L["NewVacancy"].Value
        </a>
    </div>

    <form id="SearchForm" class="mb-3" autocomplete="off">
        <div class="input-group">
            <input class="form-control" id="FilterText" placeholder="@L["Search"]" />
            <button class="btn btn-primary" type="submit"><i class="fa fa-search"></i></button>
        </div>
    </form>

    <div class="table-responsive">
        <table class="table table-striped align-middle" id="vacanciesTable">
            <thead>
                <tr>
                    <th>@L["Actions"]</th>
                    <th>@L["JobTitle"]</th>
                    <th>@L["Status"]</th>
                    <th>@L["CreationTime"]</th>
                    <th>@L["Reference"]</th>
                    <th>@L["Region"]</th>
                    <th>@L["RoleLevel"]</th>
                    <th>@L["Location"]</th>
                    <th>@L["LinkedInUrl"]</th>
                    <th>@L["CopyUrl"]</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

@section scripts {
    <script>
        (function(){
            const tBody = document.querySelector('#vacanciesTable tbody');
            const form = document.getElementById('SearchForm');
            const filterInput = document.getElementById('FilterText');

            async function loadVacancies(filterText = '') {
                tBody.innerHTML = '<tr><td colspan="10">Loading...</td></tr>';
                const params = new URLSearchParams({ filterText, MaxResultCount: '50', SkipCount: '0', Sorting: 'CreationTime desc' });
                const res = await fetch('/api/app/vacancies?' + params.toString());
                if (!res.ok) {
                    tBody.innerHTML = '<tr><td colspan="10">Failed to load vacancies.</td></tr>';
                    return;
                }
                const data = await res.json();
                const items = data.items || [];
                if (items.length === 0) {
                    tBody.innerHTML = '<tr><td colspan="10">No vacancies found.</td></tr>';
                    return;
                }
                tBody.innerHTML = items.map(x => renderRow(x)).join('');
            }

            function escapeHtml(s){return (s||'').toString().replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));}

            function renderRow(item){
                const v = item.vacancy || {}; const company = item.company || {}; const user = item.identityUser || {};
                const url = v.vacancyDetailUrl || '';
                return `
                    <tr>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a class="btn btn-outline-primary" href="/Vacancies/${escapeHtml(v.id)}/Edit"><i class="fa fa-edit"></i></a>
                            </div>
                        </td>
                        <td>${escapeHtml(v.title)}</td>
                        <td>${escapeHtml((v.vacancyStatus||'').toString())}</td>
                        <td>${escapeHtml(v.creationTime||'')}</td>
                        <td>${escapeHtml(v.reference)}</td>
                        <td>${escapeHtml((v.regionDescriptions||[]).join(', '))}</td>
                        <td>${escapeHtml(v.role||'')}</td>
                        <td>${escapeHtml(v.location||'')}</td>
                        <td>${v.linkedInUrl?`<a href="${escapeHtml(v.linkedInUrl)}" target="_blank">Link</a>`:''}</td>
                        <td>${url?`<button class="btn btn-secondary btn-sm copy-vacancy-url" data-url="${escapeHtml(url)}"><i class="fa fa-copy"></i> ${escapeHtml('@L["CopyUrl"].Value')}</button>`:'-'}</td>
                    </tr>`;
            }

            document.body.addEventListener('click', function(e){
                const btn = e.target.closest('.copy-vacancy-url');
                if (!btn) return;
                const url = btn.getAttribute('data-url');
                navigator.clipboard.writeText(url).then(()=>{
                    btn.classList.remove('btn-secondary');btn.classList.add('btn-success');
                    btn.innerHTML = '<i class="fa fa-check"></i> Copied';
                    setTimeout(()=>{btn.classList.add('btn-secondary');btn.classList.remove('btn-success');btn.innerHTML = '<i class="fa fa-copy"></i> Copy';}, 1500);
                });
            });

            form.addEventListener('submit', function(ev){
                ev.preventDefault();
                loadVacancies(filterInput.value || '');
            });

            loadVacancies();
        })();
    </script>
}